<html><head><link rel="import" href="../polymer/polymer.html">
<link rel="import" href="firebase-database-behavior.html">



</head><body><dom-module id="firebase-query">
  <script>!function(){"use strict";Polymer({is:"firebase-query",behaviors:[Polymer.FirebaseDatabaseBehavior],properties:{query:{type:Object,computed:"__computeQuery(ref, orderByChild, limitToFirst, limitToLast, startAt, endAt, equalTo)",observer:"__queryChanged"},orderByChild:{type:String,value:""},startAt:{type:String,value:""},endAt:{type:String,value:""},equalTo:{type:Object,value:null},limitToFirst:{type:Number,value:0},limitToLast:{type:Number,value:0}},created:function(){this.__map={}},attached:function(){this.__queryChanged(this.query,this.query)},detached:function(){null!=this.query&&this.__queryChanged(null,this.query)},child:function(e){return this.__map[e]},get isNew(){return this.disabled||!this.__pathReady(this.path)},get zeroValue(){return[]},memoryPathToStoragePath:function(e){var t=this.path;if("data"!==e){var i=e.split("."),a=window.parseInt(i[1],10);null==a||isNaN(a)||(i[1]=null!=this.data[a]&&this.data[a].$key),t+=i.join("/").replace(/^data\.?/,"")}return t},storagePathToMemoryPath:function(e){var t="data";if(e!==this.path){var i=e.replace(this.path+"/","").split("/"),a=i[0],r=this.__map[a];r&&(i[0]=this.__indexFromKey(a)),t+="."+i.join(".")}return t},setStoredValue:function(e,t){return e===this.path||/\$key$/.test(e)?Promise.resolve():this._setFirebaseValue(e,t)},_propertyToKey:function(e){var t=window.parseInt(e,10);if(null!=t&&!isNaN(t))return this.data[t].$key},__computeQuery:function(e,t,i,a,r,s,n){if(null==e)return null;var o;return o=t?e.orderByChild(t):e.orderByKey(),i?o=o.limitToFirst(i):a&&(o=o.limitToLast(a)),r&&(o=o.startAt(r)),s&&(o=o.endAt(s)),null!==n&&(o=o.equalTo(n)),o},__queryChanged:function(e,t){t&&(t.off("child_added",this.__onFirebaseChildAdded,this),t.off("child_removed",this.__onFirebaseChildRemoved,this),t.off("child_changed",this.__onFirebaseChildChanged,this),t.off("child_moved",this.__onFirebaseChildMoved,this),this.syncToMemory(function(){this.set("data",this.zeroValue)})),e&&(e.on("child_added",this.__onFirebaseChildAdded,this.__onError,this),e.on("child_removed",this.__onFirebaseChildRemoved,this.__onError,this),e.on("child_changed",this.__onFirebaseChildChanged,this.__onError,this),e.on("child_moved",this.__onFirebaseChildMoved,this.__onError,this))},__indexFromKey:function(e){if(null!=e)for(var t=0;t<this.data.length;t++)if(this.data[t].$key===e)return t;return-1},__onFirebaseChildAdded:function(e,t){var i=e.val(),a=e.key,r=this.__indexFromKey(t);this._log("Firebase child_added:",a,i),i.$key=a,this.__map[a]=i,this.splice("data",r+1,0,i)},__onFirebaseChildRemoved:function(e){var t=e.key,i=this.__map[t];this._log("Firebase child_removed:",t,i),i&&(this.__map[t]=null,this.async(function(){this.syncToMemory(function(){this.splice("data",this.__indexFromKey(t),1)})}))},__onFirebaseChildChanged:function(e){var t=e.key,i=this.__map[t];this._log("Firebase child_changed:",t,i),i&&this.async(function(){var a=this.__indexFromKey(t),r=e.val();r.$key=t,this.__map[t]=r,this.syncToMemory(function(){if(r instanceof Object){for(var e in r)this.set(["data",a,e],r[e]);for(var e in i)r.hasOwnProperty(e)||this.set(["data",a,e],void 0)}else this.set(["data",a],r)})})},__onFirebaseChildMoved:function(e,t){var i=e.key,a=this.__map[i],r=t?this.__indexFromKey(t):0;if(this._log("Firebase child_moved:",i,a,"to index",r),a){var s=this.__indexFromKey(i);a=e.val(),a.$key=i,this.__map[i]=a,this.async(function(){this.syncToMemory(function(){this.splice("data",s,1),this.splice("data",r,0,a)})})}}})}();</script>
</dom-module>
</body></html>